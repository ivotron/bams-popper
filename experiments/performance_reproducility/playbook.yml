- hosts: all
  tasks:
  - name: check for variables
    assert:
      that:
      - 'cpu_quota is defined'
      - 'cpu_period is defined'
      - 'threads is defined'

  - name: initialize wrf_timing if not set
    set_fact:
      wrf_timing: ''
    when: wrf_timing is not defined

  - name: tag results accordingly
    set_fact:
      wrf_exec_tag: 'no_limits'

  - name: run wrf without limits
    include: ../common/run_wrf.yml threads={{item}}
    with_items: '{{ threads }}'

  - name: set docker flags for limits and tag results accordingly
    set_fact:
      wrf_exec_tag: 'cpu_limits'

  - name: run wrf with limits
    include: ../common/run_wrf.yml threads={{item}}
    with_items: '{{ threads }}'

  - name: store results
    local_action: copy content={{ wrf_timing }} dest=./results
